generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserStatus {
  UNVERIFIED
  ACTIVE
  DISABLED
}

model User {
  id                  String    @id @default(uuid()) @db.Uuid
  email               String    @unique @db.VarChar(255)
  emailVerified       Boolean   @default(false) @map("email_verified")
  passwordHash        String    @map("password_hash") @db.VarChar(255)
  status              UserStatus @default(UNVERIFIED)
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")
  lastLoginAt         DateTime? @map("last_login_at")
  failedLoginAttempts Int       @default(0) @map("failed_login_attempts")
  lockedUntil         DateTime? @map("locked_until")

  profile              UserProfile?
  refreshTokens        RefreshToken[]
  emailVerifyTokens    EmailVerificationToken[]
  passwordResetTokens  PasswordResetToken[]
  oauthConnections     OAuthConnection[]
  auditLogs            AuditLog[]

  @@index([email])
  @@index([status])
  @@map("users")
}

model UserProfile {
  userId           String    @id @map("user_id") @db.Uuid
  givenName        String?   @map("given_name") @db.VarChar(100)
  familyName       String?   @map("family_name") @db.VarChar(100)
  nickname         String?   @db.VarChar(100)
  phoneNumber      String?   @map("phone_number") @db.VarChar(50)
  phoneVerified    Boolean   @default(false) @map("phone_verified")
  pictureUrl       String?   @map("picture_url") @db.VarChar(500)
  locale           String?   @db.VarChar(10)
  timezone         String?   @db.VarChar(50)
  birthdate        DateTime? @db.Date
  gender           String?   @db.VarChar(20)
  customAttributes Json?     @map("custom_attributes")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

model RefreshToken {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  tokenHash String    @unique @map("token_hash") @db.VarChar(255)
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")
  clientId  String?   @map("client_id") @db.VarChar(255)
  ipAddress String?   @map("ip_address") @db.VarChar(45)
  userAgent String?   @map("user_agent")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model EmailVerificationToken {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  token     String    @unique @db.VarChar(255)
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  usedAt    DateTime? @map("used_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("email_verification_tokens")
}

model PasswordResetToken {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  token     String    @unique @db.VarChar(255)
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  usedAt    DateTime? @map("used_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("password_reset_tokens")
}

model OAuthConnection {
  id             String    @id @default(uuid()) @db.Uuid
  userId         String    @map("user_id") @db.Uuid
  provider       String    @db.VarChar(50)
  providerUserId String    @map("provider_user_id") @db.VarChar(255)
  accessToken    String?   @map("access_token")
  refreshToken   String?   @map("refresh_token")
  tokenExpiresAt DateTime? @map("token_expires_at")
  profileData    Json?     @map("profile_data")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerUserId])
  @@index([userId])
  @@map("oauth_connections")
}

model AuditLog {
  id        BigInt   @id @default(autoincrement())
  userId    String?  @map("user_id") @db.Uuid
  eventType String   @map("event_type") @db.VarChar(100)
  eventData Json?    @map("event_data")
  ipAddress String?  @map("ip_address") @db.VarChar(45)
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([eventType])
  @@index([createdAt])
  @@map("audit_logs")
}
